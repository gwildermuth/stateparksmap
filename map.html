<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Qualtrics Map Selector</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Mapbox CSS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.1/mapbox-gl-geocoder.css" rel="stylesheet" />

  <style>
    html, body { height: 100%; margin: 0; }
    #map { position: absolute; inset: 0; }
    .mapboxgl-ctrl-geocoder { max-width: 520px; min-width: 260px; }
    .status {
      position: absolute; left: 8px; bottom: 8px;
      background: rgba(255,255,255,0.9); padding: 6px 8px; border-radius: 6px;
      font: 12px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      box-shadow: 0 1px 4px rgba(0,0,0,0.10);
    }
    .status code { font-size: 11px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="status">
    <div><strong>Selected:</strong> <span id="place">—</span></div>
    <div><code id="coords">lat: — , lng: —</code></div>
  </div>

  <!-- Mapbox JS -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.1/mapbox-gl-geocoder.min.js"></script>

  <script>
    // 1) Put your Mapbox token here
    mapboxgl.accessToken = 'pk.eyJ1IjoiZ3dpbGRlcm11dGgiLCJhIjoiY21nNnZmdmtsMGE1YzJrcHU0ZjFmeW5pOSJ9.SlR-H7p7JCgjn65Jcrzq6g';

    // 2) Your Pennsylvania State Parks list
    //    IMPORTANT: coordinates are [longitude, latitude]
    //    You can paste your full list in this array.
    const stateParks = [
  { name: "Allegheny Islands State Park", coordinates: [-79.845368, 40.573101] },
  { name: "Archbald Pothole State Park", coordinates: [-75.578249, 41.507150] },
  { name: "Bald Eagle State Park", coordinates: [-77.651135, 41.034513] },
  { name: "Beltzville State Park", coordinates: [-75.628723, 40.863098] },
  { name: "Bendigo State Park", coordinates: [-78.682358, 41.506969] },
  { name: "Benjamin Rush State Park", coordinates: [-74.987598, 40.113987] },
  { name: "Big Elk Creek State Park", coordinates: [-75.835656, 39.730575] },
  { name: "Big Pocono State Park", coordinates: [-75.336608, 41.053360] },
  { name: "Big Spring State Park", coordinates: [-77.581526, 40.305080] },
  { name: "Black Moshannon State Park", coordinates: [-78.056679, 40.912225] },
  { name: "Blue Knob State Park", coordinates: [-78.583537, 40.266539] },
  { name: "Boyd Big Tree Preserve Conservation Area", coordinates: [-76.871382, 40.364419] },
  { name: "Buchanan's Birthplace State Park", coordinates: [-77.954935, 39.893381] },
  { name: "Bucktail State Park Natural Area", coordinates: [-77.741539, 41.309180] },
  { name: "Caledonia State Park", coordinates: [-77.478273, 39.908747] },
  { name: "Canoe Creek State Park", coordinates: [-78.290824, 40.480405] },
  { name: "Chapman State Park", coordinates: [-79.171189, 41.757700] },
  { name: "Cherry Springs State Park", coordinates: [-77.829190, 41.666151] },
  { name: "Clear Creek State Park", coordinates: [-79.077047, 41.322982] },
  { name: "Codorus State Park", coordinates: [-76.918197, 39.789913] },
  { name: "Colonel Denning State Park", coordinates: [-77.418314, 40.280749] },
  { name: "Colton Point State Park", coordinates: [-77.432527, 41.740647] },
  { name: "Cook Forest State Park", coordinates: [-79.209363, 41.332790] },
  { name: "Cowans Gap State Park", coordinates: [-77.923989, 39.995233] },
  { name: "Delaware Canal State Park", coordinates: [-75.087151, 40.545875] },
  { name: "Denton Hill State Park", coordinates: [-77.824103, 41.776562] },
  { name: "Elk State Park", coordinates: [-78.600868, 41.561198] },
  { name: "Erie Bluffs State Park", coordinates: [-80.375976, 42.015188] },
  { name: "Evansburg State Park", coordinates: [-75.404846, 40.201147] },
  { name: "Fort Washington State Park", coordinates: [-75.217243, 40.130326] },
  { name: "Fowlers Hollow State Park", coordinates: [-77.571196, 40.281331] },
  { name: "Frances Slocum State Park", coordinates: [-75.891599, 41.347941] },
  { name: "French Creek State Park", coordinates: [-75.792986, 40.198245] },
  { name: "Gifford Pinchot State Park", coordinates: [-76.888474, 40.087026] },
  { name: "Gouldsboro State Park", coordinates: [-75.469032, 41.243382] },
  { name: "Greenwood Furnace State Park", coordinates: [-77.754468, 40.650644] },
  { name: "Hickory Run State Park", coordinates: [-75.834642, 41.009169] },
  { name: "Hillman State Park", coordinates: [-80.405938, 40.468595] },
  { name: "Hills Creek State Park", coordinates: [-77.190803, 41.804155] },
  { name: "Hyner Run State Park", coordinates: [-77.627897, 41.358347] },
  { name: "Hyner View State Park", coordinates: [-77.603179, 41.339886] },
  { name: "Jacobsburg Environmental Education Center", coordinates: [-75.294500, 40.784040] },
  { name: "Jennings Environmental Education Center", coordinates: [-80.005580, 41.007843] },
  { name: "Joseph E. Ibberson Conservation Area", coordinates: [-76.861957, 40.443167] },
  { name: "Kettle Creek State Park", coordinates: [-77.928956, 41.376026] },
  { name: "Keystone State Park", coordinates: [-79.379763, 40.376039] },
  { name: "Kings Gap Environmental Education Center", coordinates: [-77.265456, 40.093283] },
  { name: "Kinzua Bridge State Park", coordinates: [-78.587023, 41.759822] },
  { name: "Kooser State Park", coordinates: [-79.228875, 40.061450] },
  { name: "Lackawanna State Park", coordinates: [-75.704932, 41.561850] },
  { name: "Laurel Hill State Park", coordinates: [-79.224136, 40.010092] },
  { name: "Laurel Mountain State Park", coordinates: [-79.126810, 40.172146] },
  { name: "Laurel Ridge State Park", coordinates: [-79.364317, 39.956902] },
  { name: "Laurel Summit State Park", coordinates: [-79.154032, 40.063613] },
  { name: "Lehigh Gorge State Park (North)", coordinates: [-75.773122, 41.062943] },
  { name: "Lehigh Gorge State Park (South)", coordinates: [-75.764408, 40.964603] },
  { name: "Leonard Harrison State Park", coordinates: [-77.451410, 41.697900] },
  { name: "Linn Run State Park", coordinates: [-79.213213, 40.154448] },
  { name: "Little Buffalo State Park", coordinates: [-77.168213, 40.458741] },
  { name: "Little Pine State Park", coordinates: [-77.357518, 41.363154] },
  { name: "Locust Lake State Park", coordinates: [-76.117438, 40.784980] },
  { name: "Lyman Run State Park", coordinates: [-77.848678, 41.748148] },
  { name: "Marsh Creek State Park", coordinates: [-75.718267, 40.065776] },
  { name: "Maurice K. Goddard State Park", coordinates: [-80.144937, 41.427351] },
  { name: "McCalls Dam State Park", coordinates: [-77.183493, 41.016217] },
  { name: "McConnells Mill State Park", coordinates: [-80.183039, 40.950485] },
  { name: "Memorial Lake State Park", coordinates: [-76.601560, 40.423793] },
  { name: "Milton State Park", coordinates: [-76.842805, 41.010980] },
  { name: "Mont Alto State Park", coordinates: [-77.553300, 39.842460] },
  { name: "Moraine State Park", coordinates: [-80.097048, 40.939669] },
  { name: "Mount Pisgah State Park", coordinates: [-76.672895, 41.804508] },
  { name: "Nescopeck State Park", coordinates: [-75.954209, 41.040929] },
  { name: "Neshaminy State Park", coordinates: [-74.921981, 40.078963] },
  { name: "Nockamixon State Park", coordinates: [-75.242013, 40.463580] },
  { name: "Nolde Forest Environmental Education Center", coordinates: [-75.946667, 40.272313] },
  { name: "Norristown Farm Park", coordinates: [-75.342300, 40.145590] },
  { name: "Ohiopyle State Park", coordinates: [-79.494524, 39.866791] },
  { name: "Oil Creek State Park", coordinates: [-79.689321, 41.488053] },
  { name: "Ole Bull State Park", coordinates: [-77.715380, 41.537772] },
  { name: "Parker Dam State Park", coordinates: [-78.511700, 41.193494] },
  { name: "Patterson State Park", coordinates: [-77.895330, 41.708503] },
  { name: "Penn-Roosevelt State Park", coordinates: [-77.698624, 40.720817] },
  { name: "Pine Grove Furnace State Park", coordinates: [-77.304536, 40.032961] },
  { name: "Poe Paddy State Park", coordinates: [-77.417563, 40.833630] },
  { name: "Poe Valley State Park", coordinates: [-77.477042, 40.818858] },
  { name: "Point State Park", coordinates: [-80.006904, 40.441035] },
  { name: "Presque Isle State Park", coordinates: [-80.153508, 42.109518] },
  { name: "Prince Gallitzin State Park", coordinates: [-78.559769, 40.649436] },
  { name: "Promised Land State Park", coordinates: [-75.214151, 41.299201] },
  { name: "Prompton State Park", coordinates: [-75.389208, 41.626031] },
  { name: "Prouty Place State Park", coordinates: [-77.912454, 41.672015] },
  { name: "Pymatuning State Park", coordinates: [-80.468239, 41.499340] },
  { name: "Raccoon Creek State Park", coordinates: [-80.424110, 40.502953] },
  { name: "Ralph Stover State Park", coordinates: [-75.099186, 40.434094] },
  { name: "Ravensburg State Park", coordinates: [-77.236074, 41.123602] },
  { name: "Raymond B. Winter State Park", coordinates: [-77.202316, 40.992972] },
  { name: "Reeds Gap State Park", coordinates: [-77.476870, 40.722400] },
  { name: "Ricketts Glen State Park", coordinates: [-76.302889, 41.336052] },
  { name: "Ridley Creek State Park", coordinates: [-75.437574, 39.950796] },
  { name: "Ryerson Station State Park", coordinates: [-80.445007, 39.886475] },
  { name: "Salt Springs State Park", coordinates: [-75.865337, 41.912212] },
  { name: "Samuel S. Lewis State Park", coordinates: [-76.549645, 39.996714] },
  { name: "Sand Bridge State Park", coordinates: [-77.126963, 40.987685] },
  { name: "Shawnee State Park", coordinates: [-78.635545, 40.026486] },
  { name: "Shikellamy State Park", coordinates: [-76.788549, 40.885844] },
  { name: "Simon B. Elliott State Park", coordinates: [-78.525667, 41.112644] },
  { name: "Sinnemahoning State Park", coordinates: [-78.113669, 41.687410] },
  { name: "Sizerville State Park", coordinates: [-78.183677, 41.595998] },
  { name: "Susquehanna Riverlands State Park", coordinates: [-76.549645, 39.996714] },
  { name: "Susquehanna State Park", coordinates: [-77.048881, 41.233097] },
  { name: "Susquehannock State Park", coordinates: [-76.266819, 39.810403] },
  { name: "Swatara State Park", coordinates: [-76.515026, 40.511800] },
  { name: "Tobyhanna State Park", coordinates: [-78.590264, 40.015332] },
  { name: "Trough Creek State Park", coordinates: [-78.129725, 40.312126] },
  { name: "Tuscarora State Park", coordinates: [-76.027462, 40.805952] },
  { name: "Tyler State Park", coordinates: [-74.951314, 40.233374] },
  { name: "Upper Pine Bottom State Park", coordinates: [-77.474959, 41.328602] },
  { name: "Varden Conservation Area", coordinates: [-75.401396, 41.479416] },
  { name: "Vosburg Neck State Park", coordinates: [-76.008811, 41.554077] },
  { name: "Warriors Path State Park", coordinates: [-78.242395, 40.201100] },
  { name: "Washington Crossing Historic Park", coordinates: [-74.872017, 40.295904] },
  { name: "Whipple Dam State Park", coordinates: [-77.861160, 40.685777] },
  { name: "White Clay Creek Preserve", coordinates: [-75.774726, 39.746214] },
  { name: "Worlds End State Park", coordinates: [-76.601316, 41.489442] },
  { name: "Yellow Creek State Park", coordinates: [-79.001071, 40.577822] }
];

    // 3) Init map
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v11',
      center: [-77, 41], // roughly center of PA
      zoom: 6
    });

    // 4) Local geocoder: add state parks to the built-in Mapbox results
    function forwardGeocoder(query) {
      const q = query.toLowerCase();
      const matches = [];
      for (const park of stateParks) {
        if (park.name.toLowerCase().includes(q)) {
          matches.push({
            center: park.coordinates,
            place_name: park.name,
            place_type: ["park"],
            type: "Feature",
            geometry: { type: "Point", coordinates: park.coordinates },
            properties: {}
          });
        }
      }
      return matches;
    }

    // 5) Geocoder control (global + local)
    const geocoder = new MapboxGeocoder({
      accessToken: mapboxgl.accessToken,
      localGeocoder: forwardGeocoder,
      placeholder: 'Search for a town, address, or state park',
      zoom: 10,
      mapboxgl: mapboxgl
    });
    map.addControl(geocoder, 'top-left');

    // 6) Draggable marker + selection display + postMessage back to parent (Qualtrics)
    const marker = new mapboxgl.Marker({ draggable: true });

    function updateStatus(name, lng, lat) {
      document.getElementById('place').textContent = name || 'Custom Location';
      document.getElementById('coords').textContent = `lat: ${lat.toFixed(6)}, lng: ${lng.toFixed(6)}`;
    }

    function sendSelection(name, lng, lat) {
      updateStatus(name, lng, lat);
      // post message to parent (Qualtrics will listen and save to Embedded Data)
      window.parent?.postMessage({ place: name, lat, lng }, '*');
      console.log('Selected:', { place: name, lat, lng });
    }

    geocoder.on('result', (e) => {
      const [lng, lat] = e.result.center;
      marker.setLngLat([lng, lat]).addTo(map);
      sendSelection(e.result.place_name, lng, lat);
    });

    marker.on('dragend', () => {
      const { lng, lat } = marker.getLngLat();
      sendSelection('Custom Location', lng, lat);
    });

    // 7) Make smaller town names appear earlier / more often
    map.on('load', () => {
      const layers = map.getStyle().layers || [];
      layers.forEach((l) => {
        const isSymbol = l.type === 'symbol';
        const srcLayer = l['source-layer'] || '';
        const looksLikePlace = srcLayer.includes('place') || (l.id && (l.id.includes('place') || l.id.includes('settlement')));
        if (isSymbol && looksLikePlace) {
          try {
            map.setLayerZoomRange(l.id, 0, 24);             // show at all zooms
            map.setLayoutProperty(l.id, 'text-allow-overlap', true); // allow more labels
          } catch (err) { /* some layers may not accept these props */ }
        }
      });
    });

    // 8) Basic error surface (helps debugging token/restrictions)
    map.on('error', (e) => {
      // Let Mapbox errors show in console, but surface a hint on the page if style fails
      if (e && e.error) {
        console.error('Mapbox error:', e.error);
      }
    });
  </script>
</body>
</html>
